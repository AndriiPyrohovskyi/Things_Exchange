import "reflect-metadata"
import * as express from 'express'
import * as path from 'path'
import { AppDataSource } from "./data-source"
import { User, UserRole, UserStatus } from "./src/entity/User"
import { Listing } from "./src/entity/Listing"
import { Request as ExchangeRequest } from "./src/entity/Request"
import { ListingAction } from "./src/entity/ListingAction"
import { ModerationAction } from "./src/entity/ModerationAction"

const app = express()
const port = 3010

app.set('view engine', 'ejs')
app.set('views', path.join(__dirname, 'views'))
app.use(express.static('public'))
app.use(express.urlencoded({ extended: true }))
app.use(express.json())

AppDataSource.initialize().then(() => {
    console.log("‚úÖ Database connected")

    app.listen(port, () => {
        console.log(`üöÄ Server running on http://localhost:${port}`)
    })
}).catch(error => {
    console.log("‚ùå Database error:", error)
    process.exit(1)
})

// –ì–æ–ª–æ–≤–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞
app.get('/', async (req, res) => {
    console.log("üì• Request to /")
    try {
        console.log("üîç Counting users...")
        const userCount = await AppDataSource.getRepository(User).count()
        console.log(`üë• Users: ${userCount}`)
        
        console.log("üîç Counting listings...")
        const listingCount = await AppDataSource.getRepository(Listing).count()
        console.log(`üìã Listings: ${listingCount}`)
        
        console.log("üîç Counting requests...")
        const requestCount = await AppDataSource.getRepository(ExchangeRequest).count()
        console.log(`üì¨ Requests: ${requestCount}`)
        
        console.log("üé® Rendering template...")
        res.render('index', { 
            userCount, 
            listingCount, 
            requestCount 
        })
        console.log("‚úÖ Response sent")
    } catch (error) {
        console.error("‚ùå Error in /:", error)
        res.render('error', { error })
    }
})

// JOIN –∑–∞–ø–∏—Ç–∏
app.get('/joins', async (req, res) => {
    try {
        // JOIN 1: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑ —ó—Ö –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è–º–∏
        const usersWithListings = await AppDataSource
            .getRepository(User)
            .createQueryBuilder('user')
            .leftJoinAndSelect('user.listings', 'listing')
            .where('user.role = :role', { role: UserRole.USER })
            .limit(10)
            .getMany()

        // JOIN 2: –û–≥–æ–ª–æ—à–µ–Ω–Ω—è –∑ –¥—ñ—è–º–∏ –º–æ–¥–µ—Ä–∞—Ü—ñ—ó
        const listingsWithActions = await AppDataSource
            .getRepository(Listing)
            .createQueryBuilder('listing')
            .leftJoinAndSelect('listing.user', 'user')
            .leftJoinAndSelect('listing.moderationActions', 'action')
            .leftJoinAndSelect('action.actor', 'actor')
            .limit(10)
            .getMany()

        res.render('joins', { 
            usersWithListings, 
            listingsWithActions 
        })
    } catch (error) {
        res.render('error', { error })
    }
})

// –ê–≥—Ä–µ–≥–∞—Ç–Ω—ñ –∑–∞–ø–∏—Ç–∏
app.get('/aggregates', async (req, res) => {
    try {
        // COUNT: –ö—ñ–ª—å–∫—ñ—Å—Ç—å –æ–≥–æ–ª–æ—à–µ–Ω—å –ø–æ —Å—Ç–∞—Ç—É—Å–∞—Ö
        const listingsByStatus = await AppDataSource
            .getRepository(Listing)
            .createQueryBuilder('listing')
            .select('listing.status', 'status')
            .addSelect('COUNT(*)', 'count')
            .groupBy('listing.status')
            .getRawMany()

        // AVG: –°–µ—Ä–µ–¥–Ω—ñ–π –±–∞–ª–∞–Ω—Å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        const avgBalance = await AppDataSource
            .getRepository(User)
            .createQueryBuilder('user')
            .select('AVG(user.balance)', 'avgBalance')
            .getRawOne()

        // SUM: –ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞ –±–∞–ª–∞–Ω—Å—ñ–≤ –ø–æ —Ä–æ–ª—è—Ö
        const balanceByRole = await AppDataSource
            .getRepository(User)
            .createQueryBuilder('user')
            .select('user.role', 'role')
            .addSelect('SUM(user.balance)', 'totalBalance')
            .addSelect('COUNT(*)', 'userCount')
            .groupBy('user.role')
            .getRawMany()

        res.render('aggregates', { 
            listingsByStatus, 
            avgBalance, 
            balanceByRole 
        })
    } catch (error) {
        res.render('error', { error })
    }
})

// GROUP BY —Ç–∞ HAVING
app.get('/groupby', async (req, res) => {
    try {
        // –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑ –±—ñ–ª—å—à –Ω—ñ–∂ 2 –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è–º–∏
        const activeUsers = await AppDataSource
            .getRepository(User)
            .createQueryBuilder('user')
            .leftJoin('user.listings', 'listing')
            .select('user.id', 'id')
            .addSelect('user.username', 'username')
            .addSelect('user.firstName', 'firstName')
            .addSelect('user.secondName', 'secondName')
            .addSelect('COUNT(listing.id)', 'listingCount')
            .groupBy('user.id')
            .having('COUNT(listing.id) > :count', { count: 2 })
            .orderBy('COUNT(listing.id)', 'DESC')
            .getRawMany()

        res.render('groupby', { activeUsers })
    } catch (error) {
        res.render('error', { error })
    }
})

// CRUD –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
app.get('/users', async (req, res) => {
    try {
        const users = await AppDataSource
            .getRepository(User)
            .find({
                order: { id: 'ASC' },
                take: 50
            })
        
        res.render('users', { users })
    } catch (error) {
        res.render('error', { error })
    }
})
app.get('/users/new', (req, res) => {
    res.render('user-create')
})
app.get('/users/:id', async (req, res) => {
    try {
        const user = await AppDataSource
            .getRepository(User)
            .findOne({
                where: { id: parseInt(req.params.id) },
                relations: ['listings']
            })
        
        if (!user) {
            return res.status(404).render('error', { error: 'User not found' })
        }
        
        res.render('user-detail', { user })
    } catch (error) {
        res.render('error', { error })
    }
})

app.post('/users/:id/update', async (req, res) => {
    try {
        const userId = parseInt(req.params.id)
        if (isNaN(userId)) {
            return res.render('error', { error: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞' })
        }
        
        const { firstName, secondName, email, balance } = req.body
        
        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –±–∞–ª–∞–Ω—Å—É
        const parsedBalance = parseFloat(balance)
        if (isNaN(parsedBalance)) {
            return res.render('error', { error: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É' })
        }
        
        await AppDataSource
            .getRepository(User)
            .update(
                { id: userId },
                { 
                    firstName: firstName?.trim(), 
                    secondName: secondName?.trim(), 
                    email: email?.trim(), 
                    balance: parsedBalance 
                }
            )
        
        res.redirect(`/users/${userId}`)
    } catch (error) {
        console.error('Error updating user:', error)
        res.render('error', { error: error.message })
    }
})

app.post('/users/:id/delete', async (req, res) => {
    try {
        const userId = parseInt(req.params.id)
        if (isNaN(userId)) {
            return res.render('error', { error: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞' })
        }
        
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
        await AppDataSource.transaction(async manager => {
            console.log(`üóëÔ∏è –í–∏–¥–∞–ª—è—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${userId} —Ç–∞ –≤—Å—ñ –ø–æ–≤'—è–∑–∞–Ω—ñ –¥–∞–Ω—ñ...`)
            
            // 1. –í–∏–¥–∞–ª—è—î–º–æ –¥—ñ—ó –∑ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è–º–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            await manager.query(`
                DELETE la FROM listing_action la 
                INNER JOIN listing l ON la.listing_id = l.id 
                WHERE l.user_id = ?
            `, [userId])
            console.log('‚úÖ –í–∏–¥–∞–ª–µ–Ω–æ –¥—ñ—ó –∑ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è–º–∏')
            
            // 2. –í–∏–¥–∞–ª—è—î–º–æ –∑–∞–ø–∏—Ç–∏ –Ω–∞ –æ–±–º—ñ–Ω (—è–∫ –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫ —ñ —è–∫ –æ—Ç—Ä–∏–º—É–≤–∞—á)
            await manager.query(`
                DELETE FROM request 
                WHERE sender_id = ? OR receiver_id = ?
            `, [userId, userId])
            console.log('‚úÖ –í–∏–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Ç–∏ –Ω–∞ –æ–±–º—ñ–Ω')
            
            // 3. –í–∏–¥–∞–ª—è—î–º–æ –¥—ñ—ó –º–æ–¥–µ—Ä–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (—è–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä)
            await manager.query(`
                DELETE FROM moderation_action 
                WHERE moderator_id = ?
            `, [userId])
            console.log('‚úÖ –í–∏–¥–∞–ª–µ–Ω–æ –¥—ñ—ó –º–æ–¥–µ—Ä–∞—Ü—ñ—ó (—è–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä)')
            
            // 4. –í–∏–¥–∞–ª—è—î–º–æ –¥—ñ—ó –º–æ–¥–µ—Ä–∞—Ü—ñ—ó –Ω–∞–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º (—è–∫ —Ü—ñ–ª—å)
            await manager.query(`
                DELETE FROM moderation_action 
                WHERE target_user_id = ?
            `, [userId])
            console.log('‚úÖ –í–∏–¥–∞–ª–µ–Ω–æ –¥—ñ—ó –º–æ–¥–µ—Ä–∞—Ü—ñ—ó (—è–∫ —Ü—ñ–ª—å)')
            
            // 5. –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            await manager.query(`
                DELETE FROM listing 
                WHERE user_id = ?
            `, [userId])
            console.log('‚úÖ –í–∏–¥–∞–ª–µ–Ω–æ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è')
            
            // 6. –í–∏–¥–∞–ª—è—î–º–æ —Å–∞–º–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            await manager.query(`
                DELETE FROM user 
                WHERE id = ?
            `, [userId])
            console.log('‚úÖ –í–∏–¥–∞–ª–µ–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞')
        })
        
        console.log('üéâ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ')
        res.redirect('/users')
    } catch (error) {
        console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:', error)
        res.render('error', { 
            error: '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: ' + error.message 
        })
    }
})


app.post('/users/create', async (req, res) => {
    try {
        const { username, firstName, secondName, email, password, role, balance } = req.body
        
        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –æ–±–æ–≤'—è–∑–∫–æ–≤–∏—Ö –ø–æ–ª—ñ–≤
        if (!username?.trim() || !firstName?.trim() || !secondName?.trim() || !email?.trim() || !password?.trim()) {
            return res.render('user-create', { 
                error: '–í—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è –º–∞—é—Ç—å –±—É—Ç–∏ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ',
                formData: req.body
            })
        }
        
        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –±–∞–ª–∞–Ω—Å—É
        const parsedBalance = balance ? parseFloat(balance) : 0
        if (isNaN(parsedBalance)) {
            return res.render('user-create', { 
                error: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É',
                formData: req.body
            })
        }
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ —ñ—Å–Ω—É—î
        const existingUser = await AppDataSource
            .getRepository(User)
            .findOne({
                where: [
                    { username: username.trim() },
                    { email: email.trim() }
                ]
            })
        
        if (existingUser) {
            return res.render('user-create', { 
                error: '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ç–∞–∫–∏–º username –∞–±–æ email –≤–∂–µ —ñ—Å–Ω—É—î',
                formData: req.body
            })
        }
        
        const user = new User()
        user.username = username.trim()
        user.firstName = firstName.trim()
        user.secondName = secondName.trim()
        user.email = email.trim()
        user.password = password.trim()
        user.role = role as UserRole
        user.status = UserStatus.ACTIVE
        user.balance = parsedBalance
        
        const savedUser = await AppDataSource.getRepository(User).save(user)
        
        res.redirect(`/users/${savedUser.id}`)
    } catch (error) {
        console.error('Error creating user:', error)
        res.render('user-create', { 
            error: error.message,
            formData: req.body
        })
    }
})

app.get('/users/:id/edit', async (req, res) => {
    try {
        const user = await AppDataSource
            .getRepository(User)
            .findOne({
                where: { id: parseInt(req.params.id) }
            })
        
        if (!user) {
            return res.status(404).render('error', { error: 'User not found' })
        }
        
        res.render('user-edit', { user })
    } catch (error) {
        res.render('error', { error })
    }
})

app.get('/users/:id/delete-confirm', async (req, res) => {
    try {
        const user = await AppDataSource
            .getRepository(User)
            .findOne({
                where: { id: parseInt(req.params.id) },
                relations: ['listings']
            })
        
        if (!user) {
            return res.status(404).render('error', { error: 'User not found' })
        }
        
        res.render('user-delete-confirm', { user })
    } catch (error) {
        res.render('error', { error })
    }
})

app.get('/test', (req, res) => {
    res.send('Server is working!')
})